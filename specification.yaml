openapi: 3.0.3
info:
  title: Library API
  description: >
    OpenAPI 3.0 specification for the demo Flask library API.
    Includes endpoints in api/v1 and api/v2 (books, library), user management,
    auth (register/login), and health check based on the repository code.
  version: "1.0.0"
servers:
  - url: http://localhost:5000
    description: Local development server

tags:
  - name: Health
    description: Health check endpoints
  - name: Auth
    description: Registration and login
  - name: Users
    description: User management and borrow history
  - name: Books
    description: Book catalog (v1)
  - name: Books v2
    description: Book catalog (v2) with filtering
  - name: Library
    description: Borrow / Return and borrow history (v1)
  - name: Library v2
    description: Borrow / Return and borrow history (v2 with include=book)

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    MessageResponse:
      type: object
      properties:
        message:
          type: string
      example:
        message: "User registered successfully"
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
      example:
        error: "Missing required fields: title, author, quantity"
    HealthResponse:
      type: object
      properties:
        status:
          type: string
      example:
        status: "ok"

    User:
      type: object
      properties:
        id:
          type: integer
        name:
          type: string
        email:
          type: string
        _links:
          type: object
      required:
        - id
        - name
      example:
        id: 1
        name: "Alice"
        email: "alice@example.com"
        _links:
          self:
            href: "http://localhost:5000/api/v1/users/1"
            method: "GET"

    Book:
      type: object
      properties:
        id:
          type: integer
        title:
          type: string
        author:
          type: string
        quantity:
          type: integer
        _links:
          type: object
      required:
        - id
        - title
        - author
        - quantity
      example:
        id: 10
        title: "The Example Book"
        author: "Author Name"
        quantity: 3
        _links:
          self:
            href: "http://localhost:5000/api/v1/books/10"
            method: "GET"
          collection:
            href: "http://localhost:5000/api/v1/books"
            method: "GET"
          borrow:
            href: "http://localhost:5000/api/v1/borrow"
            method: "POST"
            schema:
              user_id: "integer"
              book_id: "integer"

    BorrowRecordBase:
      type: object
      properties:
        id:
          type: integer
        user_id:
          type: integer
        user_name:
          type: string
        borrow_date:
          type: string
          format: date-time
        return_date:
          type: string
          format: date-time
          nullable: true

    BorrowRecord:
      allOf:
        - $ref: '#/components/schemas/BorrowRecordBase'
        - type: object
          properties:
            book:
              type: object
              nullable: true
              properties:
                id:
                  type: integer
                title:
                  type: string
                author:
                  type: string
                quantity:
                  type: integer
      example:
        id: 5
        user_id: 1
        user_name: "Alice"
        borrow_date: "2025-01-01T12:00:00Z"
        return_date: null
        book:
          id: 10
          title: "The Example Book"
          author: "Author Name"
          quantity: 2
        _links:
          user:
            href: "http://localhost:5000/api/v1/users/1"
            method: "GET"
          book:
            href: "http://localhost:5000/api/v1/books/10"
            method: "GET"

    PaginatedBooks:
      type: object
      properties:
        total_items:
          type: integer
        total_pages:
          type: integer
        current_page:
          type: integer
        data:
          type: array
          items:
            $ref: '#/components/schemas/Book'
        next_page_url:
          type: string
          nullable: true
        prev_page_url:
          type: string
          nullable: true

    PaginatedUsers:
      type: object
      properties:
        total_items:
          type: integer
        total_pages:
          type: integer
        current_page:
          type: integer
        data:
          type: array
          items:
            $ref: '#/components/schemas/User'
        next_page_url:
          type: string
          nullable: true
        prev_page_url:
          type: string
          nullable: true

  parameters:
    PageParam:
      name: page
      in: query
      schema:
        type: integer
        default: 1
        minimum: 1
      description: Page number (1-based)
    LimitParam:
      name: limit
      in: query
      schema:
        type: integer
        default: 10
        minimum: 1
      description: Items per page (limit)
    TitleFilter:
      name: title
      in: query
      schema:
        type: string
      description: Filter by title (case-insensitive, partial match). v2 only.
    AuthorFilter:
      name: author
      in: query
      schema:
        type: string
      description: Filter by author (case-insensitive, partial match). v2 only.
    IncludeParam:
      name: include
      in: query
      schema:
        type: string
        enum: [book]
      description: Use include=book to embed full book details in borrow history (v2)

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  /api/v1/register:
    post:
      tags:
        - Auth
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
                - email
                - password
              properties:
                name:
                  type: string
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Missing fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Database integrity error (duplicate)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/login:
    post:
      tags:
        - Auth
      summary: Log in and receive a JWT
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - email
                - password
              properties:
                email:
                  type: string
                  format: email
                password:
                  type: string
                  format: password
      responses:
        '200':
          description: Authentication successful, returns token
          content:
            application/json:
              schema:
                type: object
                properties:
                  token:
                    type: string
                    description: JWT token
        '400':
          description: Missing email or password
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                example:
                  message: "Authentication failed"

  /api/v1/users:
    get:
      tags:
        - Users
      summary: Get paginated list of users
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: A paginated list of users
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedUsers'
        '400':
          description: Invalid paging parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - Users
      summary: Add a new user (minimal endpoint)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
      responses:
        '201':
          description: Created user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Missing required field
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/users/{user_id}:
    parameters:
      - name: user_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Users
      summary: Get single user by id
      responses:
        '200':
          description: User found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - Users
      summary: Update a user's name
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - name
              properties:
                name:
                  type: string
      responses:
        '200':
          description: Updated user
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        '400':
          description: Missing required field
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Integrity error (duplicate name)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Users
      summary: Delete user by id
      responses:
        '200':
          description: User deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/users/{user_id}/history:
    get:
      tags:
        - Users
      summary: Get borrow history for a specific user
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Borrow history list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BorrowRecord'
        '201':
          description: No borrow history found (returns message)
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                example:
                  message: "No borrow history found for this user"
        '404':
          description: User not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/books:
    get:
      tags:
        - Books
      summary: Get paginated list of books (v1)
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
      responses:
        '200':
          description: Paginated book list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedBooks'
        '400':
          description: Invalid paging parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - Books
      summary: Add a new book
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - author
                - quantity
              properties:
                title:
                  type: string
                author:
                  type: string
                quantity:
                  type: integer
      responses:
        '201':
          description: New book created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Book'
        '400':
          description: Missing or invalid fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/books/{book_id}:
    parameters:
      - name: book_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Books
      summary: Get a book by id
      responses:
        '200':
          description: Book found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Book'
        '304':
          description: Not modified (ETag matched)
        '404':
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - Books
      summary: Update a book
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                author:
                  type: string
                quantity:
                  type: integer
      responses:
        '200':
          description: Updated book
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Book'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Books
      summary: Delete a book
      responses:
        '200':
          description: Book deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v2/books:
    get:
      tags:
        - Books v2
      summary: Get paginated and filterable list of books (v2)
      parameters:
        - $ref: '#/components/parameters/PageParam'
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/TitleFilter'
        - $ref: '#/components/parameters/AuthorFilter'
      responses:
        '200':
          description: Paginated, filtered books
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PaginatedBooks'
        '400':
          description: Invalid params
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    post:
      tags:
        - Books v2
      summary: Add a new book (v2)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - title
                - author
                - quantity
              properties:
                title:
                  type: string
                author:
                  type: string
                quantity:
                  type: integer
      responses:
        '201':
          description: New book created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Book'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v2/books/{book_id}:
    parameters:
      - name: book_id
        in: path
        required: true
        schema:
          type: integer
    get:
      tags:
        - Books v2
      summary: Get a book by id (v2)
      responses:
        '200':
          description: Book found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Book'
        '304':
          description: Not modified (ETag matched)
        '404':
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - Books v2
      summary: Update a book (v2)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                author:
                  type: string
                quantity:
                  type: integer
      responses:
        '200':
          description: Updated book
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Book'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - Books v2
      summary: Delete a book (v2)
      responses:
        '200':
          description: Book deleted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '404':
          description: Book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/borrow:
    post:
      tags:
        - Library
      summary: Borrow a book (decrement quantity)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - book_id
              properties:
                user_id:
                  type: integer
                book_id:
                  type: integer
      responses:
        '200':
          description: Borrow successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Missing fields or out of stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User or book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/return:
    post:
      tags:
        - Library
      summary: Return a book (increment quantity)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - book_id
              properties:
                user_id:
                  type: integer
                book_id:
                  type: integer
      responses:
        '200':
          description: Return successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: No active borrow record or missing fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User or book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v1/borrow/history:
    get:
      tags:
        - Library
      summary: Get borrow history (v1)
      responses:
        '200':
          description: List of borrow records (book fields limited in v1)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BorrowRecord'

  /api/v2/borrow:
    post:
      tags:
        - Library v2
      summary: Borrow a book (v2)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - book_id
              properties:
                user_id:
                  type: integer
                book_id:
                  type: integer
      responses:
        '200':
          description: Borrow successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: Missing fields or out of stock
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User or book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v2/return:
    post:
      tags:
        - Library v2
      summary: Return a book (v2)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - user_id
                - book_id
              properties:
                user_id:
                  type: integer
                book_id:
                  type: integer
      responses:
        '200':
          description: Return successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MessageResponse'
        '400':
          description: No active borrow record or missing fields
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: User or book not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /api/v2/borrow/history:
    get:
      tags:
        - Library v2
      summary: Get borrow history (v2) with optional include=book
      parameters:
        - $ref: '#/components/parameters/IncludeParam'
      responses:
        '200':
          description: List of borrow records (optionally with embedded book details)
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BorrowRecord'

security:
  - bearerAuth: []